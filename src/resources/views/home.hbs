<div class="row mt-4">
   <p class="h4">Các đơn vị đang/ đã tham gia khai báo</p>
    <div id="info" class="col-md-9 mt-4 mb-4 shadow">
     <table class="table table-hover">
      <thead>
        <tr>
          <th>Mã đơn vị</th>
          <th>Tên đơn vị</th>
          <th>Ngày bắt đầu</th>
          <th>Hạn cuối</th>
          <th>Trạng thái</th>
          <th>Quyền</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
     </table>
     
          <button type="button" id="allocate" class="btn border-primary text-primary" >Cấp tài khoản <i class="far fa-edit"></i></button>
      
    </div>
    {{!-- <div class="col-md-3"> --}}
      {{!-- <div class="toast show m-4">
        <div class="toast-header">
        </div>
        <div class="toast-body">
        </div>
        <div class="toast-footer list-group list-group-horizontal">
          <a href="/statistic" class="list-group-item border-success text-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Thống kê"><i class="far fa-chart-bar"></i></a>
          <button type="button" id="allocate" class="list-group-item border-primary text-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Cấp phát"><i class="far fa-edit"></i></button>
        </div>
      </div> --}}
      {{> myUnit}}
    {{!-- </div> --}}
</div>

<div id="close-declaration-modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thay đổi quyền khai báo?</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="nameUnit" class="h5">Tên đơn vị: </p>
        <label for="timeStart">Thời gian bắt đầu</label>
        <input type="date" class="form-control mb-4" id="timeStart" name="timeStart" required="true">
        <label for="timeEnd">Thời gian kết thúc</label>
        <input type="date" class="form-control mb-4" id="timeEnd" name="timeEnd" required="true">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <label class="input-group-text" for="inputGroupSelect01">Quyền</label>
          </div>
          <select class="form-control custom-select" id="active" name="active">
            <option>Có</option>
            <option>Không</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-close-declaration" type="button" class="btn btn-danger"  data-bs-dismiss="modal">Đóng khai báo</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </div>
  </div>
</div>

<form name="allocate-unit-form" method="GET"></form>
<form name="close-declaration-form" method="POST"></form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
  var codeChild;
  var code = localStorage.getItem('code');
  var allocateForm = document.forms['allocate-unit-form'];
  var closeDeclaration = document.forms['close-declaration-form'];
  var btnAllocateUnit = document.getElementById('allocate');
  var btnCloseDeclaration = document.getElementById('btn-close-declaration');
  

  btnAllocateUnit.onclick = function () {
    allocateForm.action = '/allocate/' + code;
    allocateForm.submit();
  }

  // when dialog confirm clicked
    $('#close-declaration-modal').on('show.bs.modal', async function (event) {
     // $('.modal-title').children().remove();
     // $('.modal-body').children().remove();
      var button = $(event.relatedTarget);
      codeChild = button.data('id');

      let myObject = await fetch('/units/' + codeChild);
      let myText = await myObject.json();
     // $('#nameUnit').
      $('#timeStart input').val(myText.unit.timeStart.slice(0,10));
      $('#timeEnd input').val(myText.unit.timeEnd.slice(0,10));
    });


  btnCloseDeclaration.onclick = function() {
    var timeStart = $('#close-declaration-modal #timeStart').val().trim();
    var timeEnd = $('#close-declaration-modal #timeEnd').val().trim();
    var active = $('#close-declaration-modal #active').val().trim();
   
   var url_post = "/declare/close/" + codeChild;

        fetch(url_post, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify({timeStart: timeStart, timeEnd: timeEnd, active: active}),
        })
            .then((res) => res.json())
            .then((data) => {
              getData();
                alert(data.message);
            })
            .catch((error) => {
                //alert(error);
            });
  }

  getData();
  
  async function getData() {
    var code = localStorage.getItem('code');
    var path = '/declare/progress?code=' + code;
    let myObject = await fetch(path);
    let data = await myObject.json();
    var rate = 0;
    if (data.declared + data.declaring != 0)
       rate = Math.round((data.declared * 100/ (data.declared + data.declaring))*10000 / 10000); 
    
    $('.toast-header').children().remove();
    $('.toast-body').children().remove();
    $('.toast-header').append("<p>Mã địa phương " + data.unit.code + '</p>');
    $('.toast-body').append('<p class="h5" style="color: #400485">' + data.unit.nameUnit + '</p>');
    $('.toast-body').append('<p>Hạn cuối: ' + data.date + '</p>')
    $('.toast-body').append('<p>Tiến độ: ' + rate + '%</p>');
    if (code.length < 6) {
      $('.toast-body').append('<div class="progress"><div class="progress-bar" style="width:' 
                          + rate + '%">' + rate +'%</div></div>');
    }
    $('.toast-body').append('<p>Trạng thái: ' + data.unit.progress + '</p>');
    $('tbody').children().remove();  
    for (let i = 0; i < data.units.length; i++) {
      if (data.units[i].timeEnd == null) data.units[i].timeEnd = "null";
      if (data.units[i].timeStart == null) data.units[i].timeStart = "null";
      $('tbody').append('<tr>' +
          '<td class="code">' + data.units[i].code + '</td>' +
          '<td class="nameUnit">' + data.units[i].nameUnit + '</td>' +
          '<td class="timeStart">' + data.units[i].timeStart.slice(0,10) + '</td>' +
          '<td class="timeEnd">' + data.units[i].timeEnd.slice(0,10) + '</td>' +
          '<td class="progres">' + data.units[i].progress + '</td>' +
          '<td class="active">' + data.units[i].active + 
          ' <a id="close-modal" data-bs-toggle="modal" data-id="' + data.units[i].code +
          '" data-bs-target="#close-declaration-modal" data-bs-toggle="tooltip" data-bs-placement="top" title="Đóng khai báo">' + 
          '<i class="far fa-edit text-warning"></i></a></td>' +
        '</tr>');

    }
    

  }

// when dialog confirm clicked
    $('#close-declaration-modal').on('shown.bs.modal', async function (event) {
      console.log("Modal successful!")
      var button = $(event.relatedTarget);
      codeChild = button.data('id');

      let myObject = await fetch('/units/' + codeChild);
      let myText = await myObject.json();
      $('#nameUnit').val(myText.unit.nameUnit)
      $('#timeStart').val(myText.unit.timeStart.slice(0,10));
      $('#timeEnd').val(myText.unit.timeEnd.slice(0,10));
    });

    

  });
</script>

